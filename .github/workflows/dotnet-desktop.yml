name: .NET Core Desktop Build and Release

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:

    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 修正路径问题 - 使用 PowerShell 的正确语法
    - name: Check local DLLs (CMD)
      shell: cmd
      run: |
        dir "Sap2000MeshGenerator\SAP2000 model\*SAP2000v19*" /s

    # 手动确保 DLL 在输出目录中
    - name: Copy local DLLs to output
      shell: cmd
      run: |
        copy "Sap2000MeshGenerator\SAP2000 model\SAP2000v19*.dll" "Sap2000MeshGenerator\bin\Release\" /Y
        copy "Sap2000MeshGenerator\SAP2000 model\SAP2000v19*.dll" "./publish/" /Y
        
    # 对于 packages.config 项目，使用 nuget restore
    - name: Restore NuGet packages (packages.config)
      run: nuget restore "Sap2000MeshGenerator/Sap2000MeshGenerator.sln"

    # 使用 MSBuild 编译解决方案
    - name: Build solution with MSBuild
      run: |
        msbuild "Sap2000MeshGenerator/Sap2000MeshGenerator.sln" `
          /p:Configuration=Release `
          /p:Platform="Any CPU" `
          /p:RestorePackages=false `
          /p:CopyLocalLockFileAssemblies=true

    # 发布项目使用 MSBuild
    - name: Publish executable with MSBuild
      run: |
        msbuild "Sap2000MeshGenerator/Sap2000MeshGenerator.csproj" `
          /p:Configuration=Release `
          /p:Platform="Any CPU" `
          /p:RuntimeIdentifier=win-x64 `
          /p:SelfContained=true `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:CopyLocalLockFileAssemblies=true `
          /p:DebugType=None `
          /p:DebugSymbols=false `
          /t:Publish `
          /p:PublishDir=./publish/
      
    # 检查发布结果
    - name: Check published files
      run: dir ./publish/ /s

    - name: Upload executable artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SAPMesh-Executable
        path: ./publish/
        retention-days: 30
