name: .NET Core Desktop Build and Release

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:

    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 检查本地 DLL 文件
    - name: Check SAP2000v19 DLL
      run: |
        echo "检查 SAP2000v19 DLL 文件..."
        if (Test-Path "Sap2000MeshGenerator\SAP2000 model\SAP2000v19.dll") {
          echo "✓ SAP2000v19.dll 找到"
        } else {
          echo "✗ SAP2000v19.dll 未找到"
          # 列出所有 DLL 文件
          Get-ChildItem -Path "Sap2000MeshGenerator" -Recurse -Filter "*.dll" | Select-Object Name, Directory
        }

    # 恢复 NuGet 包
    - name: Restore NuGet packages
      run: nuget restore "Sap2000MeshGenerator/Sap2000MeshGenerator.sln"

    # 构建整个解决方案
    - name: Build solution
      run: |
        msbuild "Sap2000MeshGenerator/Sap2000MeshGenerator.sln" `
          /p:Configuration=Release `
          /p:Platform="x64" `
          /p:RestorePackages=false `
          /p:CopyLocalLockFileAssemblies=true

    # 发布主项目 Sap2000MeshGenerator
    - name: Publish main executable
      run: |
        msbuild "Sap2000MeshGenerator/Sap2000MeshGenerator/Sap2000MeshGenerator.csproj" `
          /p:Configuration=Release `
          /p:Platform="x64" `
          /p:RuntimeIdentifier=win-x64 `
          /p:SelfContained=true `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:CopyLocalLockFileAssemblies=true `
          /p:DebugType=None `
          /p:DebugSymbols=false `
          /t:Publish `
          /p:PublishDir=./publish/ `
          /p:NoWarn=CS0105

    # 检查发布结果
    - name: Check published files
      run: |
        echo "=== 发布目录内容 ==="
        if (Test-Path "./publish/") {
          dir ./publish/ /s
          echo "=== 可执行文件信息 ==="
          Get-ChildItem ./publish/*.exe | ForEach-Object { 
            echo "文件: $($_.Name)"
            echo "大小: $($_.Length) bytes" 
          }
        } else {
          echo "publish 目录不存在"
          echo "=== 构建输出目录 ==="
          dir "Sap2000MeshGenerator/Sap2000MeshGenerator/bin/Release/" /s
        }

    - name: Upload executable artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SAPMesh-Executable
        path: ./publish/
        retention-days: 30